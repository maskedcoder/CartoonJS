/*!
 * Cartoon.js v2.1.0-beta 
 * Copyright (c) 2012-2013 Andrew Myers 
 * MIT License 
 */
!function(a){for(var b=0,c=["ms","moz","webkit","o"],d=0;d<c.length&&!a.requestAnimationFrame;++d)a.requestAnimationFrame=a[c[d]+"RequestAnimationFrame"],a.cancelAnimationFrame=a[c[d]+"CancelAnimationFrame"]||a[c[d]+"CancelRequestAnimationFrame"];a.requestAnimationFrame||(a.requestAnimationFrame=function(c){var d=(new Date).getTime(),e=Math.max(0,16-(d-b)),f=a.setTimeout(function(){c(d+e)},e);return b=d+e,f}),a.cancelAnimationFrame||(a.cancelAnimationFrame=function(a){clearTimeout(a)});var e=0,f=function(a,b,c){var d=typeof a,f=500,g=300,h=null;"number"==d?(f=a||f,g=b||g,h=document.createElement("canvas"),document.body.appendChild(h)):("string"==d&&(a=document.getElementById(a)),"CANVAS"==a.tagName?h=a:(h=document.createElement("canvas"),a.appendChild(h)),h.style.position="absolute",h.style.left=a.offsetLeft,h.style.top=a.offsetTop,f=b||a.clientWidth||f,g=c||a.clientHeight||g),h.id="canvas"+e,e++,h.onclick=function(a){console.log(a.layerX,a.layerY)},this.ctext=h.getContext("2d"),h.width=f,h.height=g,this.width=f,this.height=g,this.canvas=h,this._items={},h=null,a=null};f.prototype.draw=function(){var a=this.ctext;a.clearRect(0,0,this.width,this.height);for(var b in this._items)this._items[b].visible&&(a.save(),this._items[b].draw(a),a.restore())},f.prototype.addItem=function(a){this._items[a.name]=a},f.prototype.removeItem=function(a){delete this._items[a]},f.prototype.getItem=function(a){return this._items[a]};var g=function(a,b,c){var d=typeof a,f=500,g=300,h=null;"number"==d?(f=a||f,g=b||g,h=document.createElement("canvas"),document.body.appendChild(h)):("string"==d&&(a=document.getElementById(a)),"CANVAS"==a.tagName?h=a:(h=document.createElement("canvas"),a.appendChild(h)),h.style.position="absolute",h.style.left=a.offsetLeft,h.style.top=a.offsetTop,f=b||a.clientWidth||f,g=c||a.clientHeight||g),h.id="background"+e,e++,this.ctext=h.getContext("2d"),h.width=f,h.height=g,this.width=f,this.height=g,this.canvas=h,h=null,a=null};g.prototype.draw=function(){console.log("Not implemented")},a.CartoonCanvas=f,a.Background=g;var h=0,i=function(a){this.name=a||"object_"+h,this.attrs={},this.reverse=!1,this.rotation=0,this.originX=0,this.originY=0,this.visible=!0,this.x=0,this.y=0,this.scale=1,this.parent=null};i.prototype.setParent=function(a){return a instanceof i||null===a?(this.parent=a,!0):!1},i.draw=function(){console.log("Not implemented")},i.prototype.attr=function(a,b){if("object"==typeof a){var c=!0;for(var d in a)c=c&&this.attr(d,a[d]);return c}if(void 0===b)return void 0===this.attrs[a]?-1==["x","y","rotation","scale","path","reverse","closePath","visible","originX","originY"].indexOf(a)?!1:this[a]:this.attrs[a];if(void 0===this.attrs[a]){if(-1==["x","y","rotation","scale","path","reverse","closePath","visible","originX","originY"].indexOf(a))return!1;this[a]=b}else switch(a){default:this.attrs[a]=b}return!0};var j=function(a){i.call(this,a),this._path=[],this.attrs={fillStyle:"#000",font:"Arial",globalAlpha:1,globalCompositeOperation:"source-over",lineCap:"butt",lineJoin:"miter",lineWidth:1,miterLimit:10,shadowBlur:0,shadowColor:"rgba(0,0,0,0)",shadowOffsetX:0,shadowOffsetY:0,strokeStyle:"#000",textAlign:"start",textBaseLine:"alphabetic"},this.closePath=!1,this.boneMatrices={},this._bones={},this._buildingBone=!1,this._paths=[[]],this._currentPath=0,this._pathAttrs={0:{}},h++};j.prototype="function"==typeof Object.create?Object.create(i.prototype):new i(""),j.prototype.constructor=j,j.prototype.addBone=function(a){var b=a.name;return void 0===this._bones[b]&&(this._bones[b]=[],this.boneMatrices[b]=a),this},j.prototype.setBoneSegments=function(a,b){return"string"!=typeof a&&(a=a.name),void 0===this._bones[a]?!1:(this._bones[a]=b,this)},j.prototype.beginBone=function(a){var b=a.name;return void 0===this._bones[b]&&(this._bones[b]=[],this.boneMatrices[b]=a),this._buildingBone=b,this},j.prototype.endBone=function(){return this._buildingBone=!1,this},j.prototype.draw=function(a){for(var b in this.attrs)a[b]=this.attrs[b];for(var c,d,e,f,g=this._getGlobalPath(),h=this._paths,i=0,j=h.length,k=null,l=null,m=null,n=this._pathAttrs;j>i;i++){c=h[i],d=0,e=c.length;for(b in n[i])a[b]=n[i][b];for(a.beginPath();e>d;d++)switch(f=c[d],k=g[f],k.type){case"line":a.lineTo(k.x,k.y);break;case"bezierCurve":l=g[f+1],m=g[f+2],d+=2,a.bezierCurveTo(l.x,l.y,m.x,m.y,k.x,k.y);break;case"quadraticCurve":l=g[f+1],d++,a.quadraticCurveTo(l.x,l.y,k.x,k.y);break;case"arc":l=g[f+1],d++,a.arcTo(k.x,k.y,l.x,l.y,k.radius);break;default:a.moveTo(k.x,k.y)}this.closePath&&a.closePath(),a.fill(),a.stroke()}},j.prototype._getGlobal=function(a){for(var b,c,d,e,f,g,h,i=[],j=this,k=Math.PI;j;)i.push(j),j=j.parent;for(var l=i.length-1;l>-1;l--)j=i[l],b=j.originX,c=j.originY,e=j.x,f=j.y,d=j.scale,g=j.rotation,h=j.reverse?-1:1,a.translate(e+b,f+c),a.rotate(g*(k/180)),a.scale(h*d,d);return{originX:b,originY:c}},j.prototype._getGlobalPath=function(){for(var a,b,c,d,e,f,g,h=this.getPath(),i=0,j=h.length,k=0,l=0,m=null,n=0,o=0,p=null,q=[],r=[],s=this,t=Math.PI,u=Math.atan2,v=Math.sqrt,w=Math.cos,x=Math.sin;s;)r.push(s),s=s.parent;for(var y in this._bones){for(var z=[],A=this.boneMatrices[y],B=0;A;)z.push(A),A=A.parent;for(var C=0,D=z.length,E=0;D>C;C++)for(A=z[C],a=A.originX,b=A.originY,d=A.x,e=A.y,c=A.scale,f=A.rotation,E=this._bones[y].length,i=0;E>i;i++)B=this._bones[y][i],m=h[B],p={type:m.type,radius:m.radius},n=m.x-a,o=m.y-b,l=v(n*n+o*o)*c,k=(u(o,n)*(180/t)+f)*(t/180),p.x=l*w(k)+d+a,p.y=l*x(k)+e+b,h[B]=p}for(var F=0,G=r.length;G>F;F++){for(s=r[F],a=s.originX,b=s.originY,d=s.x,e=s.y,c=s.scale,f=s.rotation,g=s.reverse?-1:1,q=[],i=0;j>i;i++)m=h[i],p={type:m.type,radius:m.radius},n=(m.x-a)*g,o=m.y-b,l=v(n*n+o*o)*c,k=(u(o,n)*(180/t)+f)*(t/180),p.x=l*w(k)+d,p.y=l*x(k)+e,q.push(p);h=q}return s=null,0===q.length&&console.log(q,h,this.name,this),q},j.prototype.getPath=function(){return[].concat(this._path)},j.prototype.setPath=function(a){return this._path=a,this},j.prototype.bezierCurveTo=function(a,b,c,d,e,f){this._path.push({type:"bezierCurve",x:a,y:b}),this._path.push({type:"control1",x:c,y:d});var g=this._path.push({type:"control2",x:e,y:f});return this._buildingBone&&(this._bones[this._buildingBone]=this._bones[this._buildingBone].concat([g-3,g-2,g-1])),this._paths[this._currentPath]=this._paths[this._currentPath].concat([g-3,g-2,g-1]),this},j.prototype.quadraticCurveTo=function(a,b,c,d){this._path.push({type:"quadraticCurve",x:a,y:b});var e=this._path.push({type:"control1",x:c,y:d});return this._buildingBone&&(this._bones[this._buildingBone]=this._bones[this._buildingBone].concat([e-2,e-1])),this._paths[this._currentPath]=this._paths[this._currentPath].concat([e-2,e-1]),this},j.prototype.arcTo=function(a,b,c,d,e){this._path.push({type:"arc",x:a,y:b,radius:e});var f=this._path.push({type:"control1",x:c,y:d});return this._buildingBone&&(this._bones[this._buildingBone]=this._bones[this._buildingBone].concat([f-2,f-1])),this._paths[this._currentPath]=this._paths[this._currentPath].concat([f-2,f-1]),this},j.prototype.lineTo=function(a,b){var c=this._path.push({type:"line",x:a,y:b});return this._buildingBone&&this._bones[this._buildingBone].push(c-1),this._paths[this._currentPath].push(c-1),this},j.prototype.moveTo=function(a,b){var c=this._path.push({type:"move",x:a,y:b});return this._buildingBone&&this._bones[this._buildingBone].push(c-1),this._paths[this._currentPath].push(c-1),this},j.prototype.endPath=function(){return this._currentPath++,this._pathAttrs[this._currentPath]={},this._paths.push([]),this},j.prototype.fillFor=function(a){return this._pathAttrs[this._currentPath].fillStyle=a,this},j.prototype.strokeFor=function(a){return this._pathAttrs[this._currentPath].strokeStyle=a,this},j.prototype.lineWidthFor=function(a){return this._pathAttrs[this._currentPath].lineWidth=a,this},a.CartoonPathItem=j;var k=function(a){i.call(this,a),this.attrs={fillStyle:"#000",font:"Arial",globalAlpha:1,globalCompositeOperation:"source-over",lineCap:"butt",lineJoin:"miter",lineWidth:1,miterLimit:10,shadowBlur:0,shadowColor:"rgba(0,0,0,0)",shadowOffsetX:0,shadowOffsetY:0,strokeStyle:"#000",textAlign:"start",textBaseLine:"alphabetic"},h++};k.prototype="function"==typeof Object.create?Object.create(i.prototype):new i(""),k.prototype.constructor=k,k.prototype.getGlobal=j._getGlobal,k.prototype.customizeContext=function(a){for(var b in this.attrs)a[b]=this.attrs[b]},a.GenericCartoonItem=k;var l=function(a,b){i.call(this,a),this.attrs={globalAlpha:1,globalCompositeOperation:"source-over"},this.img=b};l.prototype="function"==typeof Object.create?Object.create(i.prototype):new i(""),l.prototype.constructor=l,l.prototype._getGlobal=j._getGlobal,l.draw=function(a){for(var b in this.attrs)a[b]=this.attrs[b];var c=this._getGlobal(a);a.drawImage(this.img,c.originX,c.originY)},a.CartoonImageItem=l;var m=0,n=function(a){this.originX=0,this.originY=0,this.x=0,this.y=0,this.rotation=0,this.scale=1,this.matrix=null,this.name=a||"matrix_"+m,m++};n.prototype.setMatrix=function(a){return a!=this&&(a instanceof n||null===a)?(this.matrix=a,!0):!1},n.prototype.draw=function(){},n.prototype.attr=function(a,b){if("object"==typeof a){var c=!0,d=null;for(d in a)c=c&&this.attr(d,a[d]);return c}return void 0===b?-1==["x","y","rotation","scale"].indexOf(a)?!1:this[a]:-1==["x","y","rotation","scale"].indexOf(a)?!1:(this[a]=b,!0)},a.Matrix=n;var o=0,p=!1,q=function(a){this.time=0,this.status="ready",this.onstep=!1,this.onstatus=!1,this.scenes={},this.sceneChanges=[],this.lastframe=0,this.audio=null,a&&this.createControls()};q.prototype.createControls=function(){return new C(this)},q.prototype.addScene=function(a,b){this.scenes[b]=a,-1==this.sceneChanges.indexOf(b)&&this.sceneChanges.push(b)},q.prototype.addAudio=function(a){this.audio=a},q.prototype.togglePlay=function(){return"ready"==this.status?(this.onstatus&&this.onstatus("playing"),this.play(),void 0):("playing"==this.status?(this.onstatus&&this.onstatus("pause"),this.pause()):(this.onstatus&&this.onstatus("playing"),this.resume()),void 0)},q.prototype.play=function(){this.sceneChanges.sort(function(a,b){return b-a});for(var a in this.scenes)this.scenes[a].compile(),this.scenes[a].hide();this.lastframe=this.scenes[this.sceneChanges[0]].lastframe,this.startTime=+new Date,this.status="playing",this.audio&&this.audio.play(),this._step()},q.prototype.stop=function(){var a=0;if("ready"==this.status){this.sceneChanges.sort(function(a,b){return b-a});for(a in this.scenes)this.scenes[a].compile(),this.scenes[a].hide();this.lastframe=this.scenes[this.sceneChanges[0]].lastframe}else this.status="ready",this.onstatus&&this.onstatus("ready");for(a in this.scenes)this.scenes[a].hide();this.time=0,this.startTime=+new Date,this.audio&&(this.audio.pause(),this.audio.currentTime=0),this._step(!0)},q.prototype.pause=function(){this.audio&&this.audio.pause(),this.status="paused"},q.prototype.resume=function(){this.startTime=+new Date-this.time,this.status="playing",this.audio&&this.audio.play(),this._step()},q.prototype.setTime=function(a){this.time=a,this.startTime=+new Date-a,this.audio&&(this.audio.currentTime=this.time/1e3);for(a in this.scenes)this.scenes[a].hide();"playing"!=this.status&&(this.status="paused"),this._step(!0)},q.prototype.back15=function(){this.time=this.time>15e3?this.time-15e3:0,this.audio&&(this.audio.currentTime=this.time/1e3);for(var a in this.scenes)this.scenes[a].hide();this.startTime=+new Date-this.time,"playing"!=this.status&&(this.status="paused"),this._step(!0)},q.prototype._step=function(a){if(a)this.time=+new Date-this.startTime;else switch(this.status){case"paused":case"ready":return;default:this.time=+new Date-this.startTime}var b=this.time;this.onstep&&this.onstep(b,this.lastframe);var c=this.sceneChanges.filter(function(a){return b>=a})[0],d=this.scenes[c];d.hidden&&(this.sceneChanges.indexOf(c)+1<this.sceneChanges.length&&this.scenes[this.sceneChanges[this.sceneChanges.indexOf(c)+1]].hide(),d.show()),d.stepAnimation(b,a),p&&b!=o&&(console.log("FPS: "+Math.floor(1e3/(b-o))),Math.floor(1e3/(b-o))<20&&console.log("Low one: "+b),o=b),a||(b<this.lastframe?function(a){requestAnimationFrame(function(){a._step()})}(this):(this.onstatus&&this.onstatus("ready"),this.status="ready"))};var r=function(a,b,c,d,e,f){switch(this.object=a,this.startState=c,this.endState=d,this.begin=e,this.end=f,this.update=null,this.type=b,b){case"path":this.update=t;break;case"stroke":case"fill":this.update=u;break;default:this.update=s}};r.prototype.isPlaying=function(a){return a>=this.begin&&a<=this.end},r.prototype.transformForTime=function(a){var b=(a-this.begin)/(this.end-this.begin);this.update(this.object,b,this.type,this.startState,this.endState)};var s=function(a,b,c,d,e){a.attr(c,(e-d)*b+d)},t=function(a,b,c,d,e){for(var f=0,g=d.length,h=null,i=null,j=null,k=[],l="",m=null;g>f;f++){h=d[f],i=e[f],j={};for(l in h)m=h[l],j[l]=isNaN(m)?m:(i[l]-m)*b+m;k.push(j)}a.attr(c,k)},u=function(){},v=function(a,b){this.background=b,this.scene=a,this._timeline={},this._immediateTimeline={},this._subAnimations=[],this.lastframe=-1,this._drawnYet=!1,this.hidden=!1,this._MYLASTFRAME=-1};v.prototype.hide=function(){this.scene.canvas.style.display="none",this.background&&(this.background.canvas.style.display="none"),this.hidden=!0},v.prototype.show=function(){this.scene.canvas.style.removeProperty("display"),this.background&&(this.background.canvas.style.removeProperty("display"),this.background.draw()),this.hidden=!1},v.prototype.stepAnimation=function(a,b){this._drawnYet=!0;for(var c=0,d=this._subAnimations,e=d.length,f=null;e>c;c++)f=d[c],f.isPlaying(a)&&f.transformForTime(a);var g,h,i,j=[];for(g in this._immediateTimeline)if(j.push(g),this._MYLASTFRAME<g&&a>=g||a<this._MYLASTFRAME&&a==g){h=this._immediateTimeline[g];for(i in h)this.scene.getItem(i).attr(h[i])}if(b)for(j.sort(function(a,b){return a-b}),c=0,e=j.length;e>c&&(g=j[c],a>=g);c++){h=this._immediateTimeline[g];for(i in h)this.scene.getItem(i).attr(h[i])}this._MYLASTFRAME=a,this.scene.draw()},v.prototype.addKeyFrame=function(a,b,c,d){b>this.lastframe&&(this.lastframe=b),"string"!=typeof a&&(a=a.name),void 0===this._timeline[a]&&(this._timeline[a]={}),void 0===this._timeline[a][c]&&(this._timeline[a][c]={keys:[]}),this._timeline[a][c][b]=d,-1==this._timeline[a][c].keys.indexOf(b)&&this._timeline[a][c].keys.push(b),void 0===this._timeline[a][c][0]&&(this._timeline[a][c][0]=this.scene.getItem(a).attr(c),this._timeline[a][c].keys.push(0))},v.prototype.addAttrChange=function(a,b,c,d){if(b>this.lastframe&&(this.lastframe=b),"string"!=typeof a&&(a=a.name),void 0===this._immediateTimeline[b]&&(this._immediateTimeline[b]={}),void 0===this._immediateTimeline[b][a]&&(this._immediateTimeline[b][a]={}),this._immediateTimeline[b][a][c]=d,!this._immediateTimeline[0]||!this._immediateTimeline[0][a]||!this._immediateTimeline[0][a][c]){var e={};e[a]={},e[a][c]=this.scene.getItem(a).attr(c),this._immediateTimeline[0]=e}},v.prototype.compile=function(){var a=function(a,b){return a-b};if(this._MYLASTFRAME=-1,this._drawnYet=!1,0===this._subAnimations.length){var b,c,d,e,f,g,h,i;for(f in this._timeline){b=this._timeline[f];for(h in b)for(c=b[h],c.keys.sort(a),d=0,e=c.keys.length;e>d;d++)g=c.keys[d],d>0&&(i=c.keys[d-1],this._subAnimations.push(new r(this.scene.getItem(f),h,c[i],c[g],i,g)))}}};var w=function(a){return document.getElementById(a)},x=!1,y=function(){w("animation-controls").style.display="none"},z=function(){w("animation-controls").style.removeProperty("display")},A=!1,B=0,C=function(b){this.animation=b;var c=w("animation-controls-container"),d='<div id="animation-controls" style="display: none; "><div id="animation-time-holder"><span id="animation-time">0:00</span></div><div class="animation-control" id="animation-toggle"><span>&nbsp;</span></div><div class="animation-control" id="animation-stop"><span>&nbsp;</span></div><div class="animation-control" id="animation-back15"><span>&nbsp;</span></div><div id="animation-meter"><span id="animation-marker" style="left: -3px; " >&nbsp;</span></div></div>';c.innerHTML+=d,c.onmouseover=function(){z(),x=a.setTimeout(y,3e3)},c.onmousemove=function(){z(),x&&a.clearTimeout(x),x=a.setTimeout(y,3e3)},c.onmouseout=function(){y()},w("animation-controls-container").onmouseover=function(b){z(),x&&a.clearTimeout(x),b.stopPropagation()},w("animation-controls-container").onmousemove=function(a){a.stopPropagation()},w("animation-toggle").onclick=function(){b.togglePlay()},w("animation-stop").onclick=function(){b.stop()},w("animation-back15").onclick=function(){b.back15()},w("animation-marker").onmousedown=function(a){0===a.button&&(A=!0,B=a.clientX)},w("animation-meter").onmousemove=function(a){if(A){var b=w("animation-marker"),c=void 0===b.style.left?0:Number(b.style.left.split("p")[0]),d=c+(a.clientX-B);d>372&&(d=372),-3>d&&(d=-3),b.style.left=d+"px",B=a.clientX,b=null}},w("animation-meter").onmouseup=function(a){if(0===a.button){var c,d=w("animation-marker");"animation-meter"==a.target.id?(c=void 0===a.offsetX?a.layerX-w("animation-meter").offsetLeft-8:a.offsetX-3,c>372&&(c=372),-3>c&&(c=-3),d.style.left=c+"px",B=a.clientX):c=void 0===d.style.left?0:Number(d.style.left.split("p")[0]);var e=(c+3)/375,f=b.lastframe*e;d=null,A=!1,b.setTime(f)}},b.onstep=this.step,b.onstatus=this.state};C.prototype.step=function(a,b){var c=a/b,d=a/1e3,e=Math.floor(d/60)+":",f=String(Math.floor(d%60));e+=1==f.length?"0":"",w("animation-time").innerHTML=e+f,A||(w("animation-marker").style.left=375*c-3+"px")},C.prototype.state=function(a){w("animation-toggle").className="animation-control "+a},a.AnimationScene=v,a.CartoonAnimation=q}(window);