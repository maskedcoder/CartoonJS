/*!
 * Cartoon.js v2.1.0-beta 
 * Copyright (c) 2012-2013 Andrew Myers 
 * MIT License 
 */
!function(a){for(var b=0,c=["ms","moz","webkit","o"],d=0;d<c.length&&!a.requestAnimationFrame;++d)a.requestAnimationFrame=a[c[d]+"RequestAnimationFrame"],a.cancelAnimationFrame=a[c[d]+"CancelAnimationFrame"]||a[c[d]+"CancelRequestAnimationFrame"];a.requestAnimationFrame||(a.requestAnimationFrame=function(c){var d=(new Date).getTime(),e=Math.max(0,16-(d-b)),f=a.setTimeout(function(){c(d+e)},e);return b=d+e,f}),a.cancelAnimationFrame||(a.cancelAnimationFrame=function(a){clearTimeout(a)});var e=0,f=function(a,b){var c=typeof a,d=500,f=300,g=null;"number"==c?(d=a||d,f=b||f,g=document.createElement("canvas"),document.body.appendChild(g)):("string"==c&&(a=document.getElementById(a)),"CANVAS"==a.tagName?g=a:(g=document.createElement("canvas"),a.appendChild(g)),g.style.position="absolute",g.style.left=a.offsetLeft,g.style.top=a.offsetTop,d=b||a.clientWidth||d),g.id="canvas"+e,e++,g.onclick=function(a){console.log(a.layerX,a.layerY)},this.ctext=g.getContext("2d"),g.width=d,g.height=f,this.width=d,this.height=f,this.canvas=g,this.items={},this.refreshOpts=0,this.background="#fff",g=null,a=null};f.prototype.draw=function(){ctext=this.ctext,ctext.clearRect(0,0,this.width,this.height);for(var a in this.items)this.items[a].visible&&(ctext.save(),this.items[a].draw(ctext),ctext.restore())},f.prototype.addItem=function(a){this.items[a.name]=a},f.prototype.removeItem=function(a){var b=this.items[a];this.items[a]=void 0,b.setParent(null)},f.prototype.getItem=function(a){return this.items[a]};var g=function(a,b,c){var d=typeof a,f=500,g=300,h=null;"number"==d?(f=a||f,g=b||g,h=document.createElement("canvas"),document.body.appendChild(h)):("string"==d&&(a=document.getElementById(a)),"CANVAS"==a.tagName?h=a:(h=document.createElement("canvas"),a.appendChild(h)),h.style.position="absolute",h.style.left=a.offsetLeft,h.style.top=a.offsetTop,f=b||a.clientWidth||f,g=c||a.clientHeight||g),h.id="background"+e,e++,this.ctext=h.getContext("2d"),h.width=f,h.height=g,this.width=f,this.height=g,this.canvas=h,h=null,a=null};g.prototype.draw=function(){console.log("Not implemented")},a.CartoonCanvas=f,a.Background=g;var h=0,i=function(a){this.path=[],this.attrs={fillStyle:"#000",font:"Arial",globalAlpha:1,globalCompositeOperation:"source-over",lineCap:"butt",lineJoin:"miter",lineWidth:1,miterLimit:10,shadowBlur:0,shadowColor:"rgba(0,0,0,0)",shadowOffsetX:0,shadowOffsetY:0,strokeStyle:"#000",textAlign:"start",textBaseLine:"alphabetic"},this.rotation=0,this.originX=0,this.originY=0,this.reverse=!1,this.closePath=!1,this.visible=!0,this.x=0,this.y=0,this.scale=1,this.parent=null,this.name=a||"object_"+h,this.bones={},this.boneMatrices={},this.buildingBone=!1,this.paths=[[]],this.currentPath=0,this.pathAttrs={0:{}},h++};i.prototype.setParent=function(a){return a instanceof i||null===a?(this.parent=a,!0):!1},i.prototype.addBone=function(a){var b=a.name;return void 0===this.bones[b]&&(this.bones[b]=[],this.boneMatrices[b]=a),this},i.prototype.setBoneSegments=function(a,b){return"string"!=typeof a&&(a=a.name),void 0===this.bones[a]?!1:(this.bones[a]=b,this)},i.prototype.beginBone=function(a){var b=a.name;return void 0===this.bones[b]&&(this.bones[b]=[],this.boneMatrices[b]=a),this.buildingBone=b,this},i.prototype.endBone=function(){return this.buildingBone=!1,this},i.prototype.draw=function(a){for(var b in this.attrs)a[b]=this.attrs[b];for(var c,d,e,f,g=this.getGlobalPath(),h=this.paths,i=0,j=h.length,k=null,l=null,m=null,n=this.pathAttrs;j>i;i++){c=h[i],d=0,e=c.length;for(b in n[i])a[b]=n[i][b];for(a.beginPath();e>d;d++)switch(f=c[d],k=g[f],k.type){case"line":a.lineTo(k.x,k.y);break;case"bezierCurve":l=g[f+1],m=g[f+2],d+=2,a.bezierCurveTo(l.x,l.y,m.x,m.y,k.x,k.y);break;case"quadraticCurve":l=g[f+1],d++,a.quadraticCurveTo(l.x,l.y,k.x,k.y);break;case"arc":l=g[f+1],d++,a.arcTo(k.x,k.y,l.x,l.y,k.radius);break;default:a.moveTo(k.x,k.y)}this.closePath&&a.closePath(),a.fill(),a.stroke()}},i.prototype.getGlobal=function(){for(var a,b,c,d,e,f,g,h=[],i=this,j=Math.PI;i;)h.push(i),i=i.parent;for(var k=h.length-1;k>-1;k--)i=h[k],a=i.originX,b=i.originY,d=i.x,e=i.y,c=i.scale,f=i.rotation,g=i.reverse?-1:1,ctext.translate(d+a,e+b),ctext.rotate(f*(j/180)),ctext.scale(g*c,c)},i.prototype.getGlobalPath=function(){for(var a,b,c,d,e,f,g=[].concat(this.getPath()),h=0,i=g.length,j=0,k=0,l=null,m=0,n=0,o=null,p=[],q=[],r=this,s=Math.PI,t=Math.atan2,u=Math.sqrt,v=Math.cos,w=Math.sin;r;)q.push(r),r=r.parent;for(var x in this.bones){for(var y=[],z=this.boneMatrices[x],A=0;z;)y.push(z),z=z.parent;for(var B=0,C=y.length,D=0;C>B;B++)for(z=y[B],a=z.originX,b=z.originY,d=z.x,e=z.y,c=z.scale,f=z.rotation,D=this.bones[x].length,h=0;D>h;h++)A=this.bones[x][h],l=g[A],o={type:l.type,radius:l.radius},m=l.x-a,n=l.y-b,k=u(m*m+n*n)*c,j=(t(n,m)*(180/s)+f)*(s/180),o.x=k*v(j)+d+a,o.y=k*w(j)+e+b,g[A]=o}for(var E=0,F=q.length;F>E;E++){for(r=q[E],a=r.originX,b=r.originY,d=r.x,e=r.y,c=r.scale,f=r.rotation,reverse=r.reverse?-1:1,p=[],h=0;i>h;h++)l=g[h],o={type:l.type,radius:l.radius},m=(l.x-a)*reverse,n=l.y-b,k=u(m*m+n*n)*c,j=(t(n,m)*(180/s)+f)*(s/180),o.x=k*v(j)+d,o.y=k*w(j)+e,p.push(o);g=p}return r=null,0===p.length&&console.log(p,g,this.name,this),p},i.prototype.getPath=function(){return this.path},i.prototype.setPath=function(a){return this.path=a,this},i.prototype.bezierCurveTo=function(a,b,c,d,e,f){this.path.push({type:"bezierCurve",x:a,y:b}),this.path.push({type:"control1",x:c,y:d});var g=this.path.push({type:"control2",x:e,y:f});return this.buildingBone&&(this.bones[this.buildingBone]=this.bones[this.buildingBone].concat([g-3,g-2,g-1])),this.paths[this.currentPath]=this.paths[this.currentPath].concat([g-3,g-2,g-1]),this},i.prototype.quadraticCurveTo=function(a,b,c,d){this.path.push({type:"quadraticCurve",x:a,y:b});var e=this.path.push({type:"control1",x:c,y:d});return this.buildingBone&&(this.bones[this.buildingBone]=this.bones[this.buildingBone].concat([e-2,e-1])),this.paths[this.currentPath]=this.paths[this.currentPath].concat([e-2,e-1]),this},i.prototype.arcTo=function(a,b,c,d,e){this.path.push({type:"arc",x:a,y:b,radius:e});var f=this.path.push({type:"control1",x:c,y:d});return this.buildingBone&&(this.bones[this.buildingBone]=this.bones[this.buildingBone].concat([f-2,f-1])),this.paths[this.currentPath]=this.paths[this.currentPath].concat([f-2,f-1]),this},i.prototype.lineTo=function(a,b){var c=this.path.push({type:"line",x:a,y:b});return this.buildingBone&&this.bones[this.buildingBone].push(c-1),this.paths[this.currentPath].push(c-1),this},i.prototype.moveTo=function(a,b){var c=this.path.push({type:"move",x:a,y:b});return this.buildingBone&&this.bones[this.buildingBone].push(c-1),this.paths[this.currentPath].push(c-1),this},i.prototype.endPath=function(){return this.currentPath++,this.pathAttrs[this.currentPath]={},this.paths.push([]),this},i.prototype.fillFor=function(a){return this.pathAttrs[this.currentPath].fillStyle=a,this},i.prototype.strokeFor=function(a){return this.pathAttrs[this.currentPath].strokeStyle=a,this},i.prototype.lineWidthFor=function(a){return this.pathAttrs[this.currentPath].lineWidth=a,this},i.prototype.attr=function(a,b){if("object"==typeof a){var c=!0;for(var d in a)c=c&&this.attr(d,a[d]);return c}if(void 0===b)return void 0===this.attrs[a]?-1==["x","y","rotation","scale","path","reverse","closePath","visible"].indexOf(a)?!1:this[a]:this.attrs[a];if(void 0===this.attrs[a]){if(-1==["x","y","rotation","scale","path","reverse","closePath","visible"].indexOf(a))return!1;this[a]=b}else switch(a){default:this.attrs[a]=b}return!0},a.CartoonItem=i;var j=0,k=function(a){this.originX=0,this.originY=0,this.x=0,this.y=0,this.rotation=0,this.scale=1,this.matrix=null,this.name=a||"matrix_"+j,j++};k.prototype.setMatrix=function(a){return a!=this&&(a instanceof k||null===a)?(this.matrix=a,!0):!1},k.prototype.draw=function(){},k.prototype.attr=function(a,b){if("object"==typeof a){var c=!0,d=null;for(d in a)c=c&&this.attr(d,a[d]);return c}return void 0===b?-1==["x","y","rotation","scale"].indexOf(a)?!1:this[a]:-1==["x","y","rotation","scale"].indexOf(a)?!1:(this[a]=b,!0)},a.Matrix=k;var l=0,m=!1,n=function(a){this.time=0,this.status="ready",this.onstep=!1,this.onstatus=!1,this.scenes={},this.sceneChanges=[],this.lastframe=0,this.audio=null,a&&this.createControls(a)};n.prototype.createControls=function(a){return new z(this,a)},n.prototype.itemTransformForTime=function(a,b){var c=null,d={},e=null,f=null;for(c in this.timeline){if(f=this.timeline[c],void 0!==f[e])for(e in f[e])d[e]=f[e];if(b==c)break}return d},n.prototype.addKeyFrame=function(a,b,c,d){b>this.lastframe&&(this.lastframe=b),"string"!=typeof a&&(a=a.name),void 0===this.timeline[a]&&(this.timeline[a]={}),void 0===this.timeline[a][c]&&(this.timeline[a][c]={keys:[]}),this.timeline[a][c][b]=d,-1==this.timeline[a][c].keys.indexOf(b)&&this.timeline[a][c].keys.push(b),void 0===this.timeline[a][c][0]&&(this.timeline[a][c][0]=this.scene.getItem(a).attr(c),this.timeline[a][c].keys.push(0))},n.prototype.addScene=function(a,b){this.scenes[b]=a,-1==this.sceneChanges.indexOf(b)&&this.sceneChanges.push(b)},n.prototype.addAudio=function(a){this.audio=a},n.prototype.togglePlay=function(){return"ready"==this.status?(this.onstatus&&this.onstatus("playing"),this.play(),void 0):("playing"==this.status?(this.onstatus&&this.onstatus("pause"),this.pause()):(this.onstatus&&this.onstatus("playing"),this.resume()),void 0)},n.prototype.play=function(){this.sceneChanges.sort(function(a,b){return b-a});for(var a in this.scenes)this.scenes[a].compile(),this.scenes[a].hide();this.lastframe=this.scenes[this.sceneChanges[0]].lastframe,this.startTime=+new Date,this.status="playing",this.audio&&this.audio.play(),this.stepAnimation()},n.prototype.stop=function(){var a=0;if("ready"==this.status){this.sceneChanges.sort(function(a,b){return b-a});for(a in this.scenes)this.scenes[a].compile(),this.scenes[a].hide();this.lastframe=this.scenes[this.sceneChanges[0]].lastframe}else this.status="ready",this.onstatus&&this.onstatus("ready");for(a in this.scenes)this.scenes[a].hide();this.time=0,this.startTime=+new Date,this.audio&&(this.audio.pause(),this.audio.currentTime=0),this.stepAnimation(!0)},n.prototype.pause=function(){this.audio&&this.audio.pause(),this.status="paused"},n.prototype.resume=function(){this.startTime=+new Date-this.time,this.status="playing",this.audio&&this.audio.play(),this.stepAnimation()},n.prototype.setTime=function(a){this.time=a,this.startTime=+new Date-a,this.audio&&(this.audio.currentTime=this.time/1e3);for(a in this.scenes)this.scenes[a].hide();"playing"!=this.status&&(this.status="paused"),this.stepAnimation(!0)},n.prototype.back15=function(){this.time=this.time>15e3?this.time-15e3:0,this.audio&&(this.audio.currentTime=this.time/1e3);for(var a in this.scenes)this.scenes[a].hide();this.startTime=+new Date-this.time,"playing"!=this.status&&(this.status="paused"),this.stepAnimation(!0)},n.prototype.stepAnimation=function(a){if(a)this.time=+new Date-this.startTime;else switch(this.status){case"paused":case"ready":return;default:this.time=+new Date-this.startTime}var b=this.time;this.onstep&&this.onstep(b,this.lastframe);var c=this.sceneChanges.filter(function(a){return b>=a})[0],d=this.scenes[c];d.hidden&&(d.show(),this.sceneChanges.indexOf(c)+1<this.sceneChanges.length&&this.scenes[this.sceneChanges[this.sceneChanges.indexOf(c)+1]].hide()),d.stepAnimation(b,a),m&&b!=l&&(console.log("FPS: "+Math.floor(1e3/(b-l))),Math.floor(1e3/(b-l))<20&&console.log("Low one: "+b),l=b),a||(b<this.lastframe?function(a){requestAnimationFrame(function(){a.stepAnimation()})}(this):(this.onstatus&&this.onstatus("ready"),this.status="ready"))};var o=function(a,b,c,d,e,f){switch(this.object=a,this.startState=c,this.endState=d,this.begin=e,this.end=f,this.update=null,this.type=b,b){case"path":this.update=q;break;case"stroke":case"fill":this.update=r;break;default:this.update=p}};o.prototype.isPlaying=function(a){return a>=this.begin&&a<=this.end},o.prototype.transformForTime=function(a){var b=(a-this.begin)/(this.end-this.begin);this.update(this.object,b,this.type,this.startState,this.endState)};var p=function(a,b,c,d,e){a.attr(c,(e-d)*b+d)},q=function(a,b,c,d,e){for(var f=0,g=d.length,h=null,i=null,j=null,k=[],l="",m=null;g>f;f++){h=d[f],i=e[f],j={};for(l in h)m=h[l],j[l]=isNaN(m)?m:(i[l]-m)*b+m;k.push(j)}a.attr(c,k)},r=function(){},s=function(a,b){this.background=b,this.scene=a,this.timeline={},this.immediateTimeline={},this.subAnimations=[],this.lastframe=-1,this.drawnYet=!1,this.hidden=!1,this.MYLASTFRAME=-1};s.prototype.hide=function(){this.scene.canvas.style.display="none",this.background&&(this.background.canvas.style.display="none"),this.hidden=!0},s.prototype.show=function(){this.scene.canvas.style.removeProperty("display"),this.background&&(this.background.canvas.style.removeProperty("display"),this.background.draw()),this.hidden=!1},s.prototype.stepAnimation=function(a,b){this.drawnYet=!0;for(var c=0,d=this.subAnimations,e=d.length,f=null;e>c;c++)f=d[c],f.isPlaying(a)&&f.transformForTime(a);var g,h,i,j=[];for(g in this.immediateTimeline)if(j.push(g),this.MYLASTFRAME<g&&a>=g||a<this.MYLASTFRAME&&a==g){h=this.immediateTimeline[g];for(i in h)this.scene.getItem(i).attr(h[i])}if(b)for(j.sort(function(a,b){return a-b}),c=0,e=j.length;e>c&&(g=j[c],a>=g);c++){h=this.immediateTimeline[g];for(i in h)this.scene.getItem(i).attr(h[i])}this.MYLASTFRAME=a,this.scene.draw()},s.prototype.addKeyFrame=function(a,b,c,d){b>this.lastframe&&(this.lastframe=b),"string"!=typeof a&&(a=a.name),void 0===this.timeline[a]&&(this.timeline[a]={}),void 0===this.timeline[a][c]&&(this.timeline[a][c]={keys:[]}),this.timeline[a][c][b]=d,-1==this.timeline[a][c].keys.indexOf(b)&&this.timeline[a][c].keys.push(b),void 0===this.timeline[a][c][0]&&(this.timeline[a][c][0]=this.scene.getItem(a).attr(c),this.timeline[a][c].keys.push(0))},s.prototype.addAttrChange=function(a,b,c,d){b>this.lastframe&&(this.lastframe=b),"string"!=typeof a&&(a=a.name),void 0===this.immediateTimeline[b]&&(this.immediateTimeline[b]={}),void 0===this.immediateTimeline[b][a]&&(this.immediateTimeline[b][a]={}),this.immediateTimeline[b][a][c]=d},s.prototype.compile=function(){var a=function(a,b){return a-b};if(this.MYLASTFRAME=-1,this.drawnYet=!1,0===this.subAnimations.length){var b,c,d,e,f,g,h,i;for(f in this.timeline){b=this.timeline[f];for(h in b)for(c=b[h],c.keys.sort(a),d=0,e=c.keys.length;e>d;d++)g=c.keys[d],d>0&&(i=c.keys[d-1],this.subAnimations.push(new o(this.scene.getItem(f),h,c[i],c[g],i,g)))}}};var t=function(a){return document.getElementById(a)},u=!1,v=function(){t("animation-controls").style.display="none"},w=function(){t("animation-controls").style.removeProperty("display")},x=!1,y=0,z=function(b,c){this.animation=b,"string"==typeof c&&(c=t(c));var d='<div id="animation-controls" style="display: none; "><div id="animation-time-holder"><span id="animation-time">0:00</span></div><div class="animation-control" id="animation-toggle"><span>&nbsp;</span></div><div class="animation-control" id="animation-stop"><span>&nbsp;</span></div><div class="animation-control" id="animation-back15"><span>&nbsp;</span></div><div id="animation-meter"><span id="animation-marker" style="left: -3px; " >&nbsp;</span></div></div>';c.innerHTML+=d,c.onmouseover=function(){w(),u=a.setTimeout(v,3e3)},c.onmousemove=function(){w(),u&&a.clearTimeout(u),u=a.setTimeout(v,3e3)},c.onmouseout=function(){v()},t("animation-controls").onmouseover=function(b){w(),u&&a.clearTimeout(u),b.stopPropagation()},t("animation-controls").onmousemove=function(a){a.stopPropagation()},t("animation-toggle").onclick=function(){b.togglePlay()},t("animation-stop").onclick=function(){b.stop()},t("animation-back15").onclick=function(){b.back15()},t("animation-marker").onmousedown=function(a){0===a.button&&(x=!0,y=a.clientX)},t("animation-meter").onmousemove=function(a){if(x){var b=t("animation-marker"),c=void 0===b.style.left?0:Number(b.style.left.split("p")[0]),d=c+(a.clientX-y);d>372&&(d=372),-3>d&&(d=-3),b.style.left=d+"px",y=a.clientX,b=null}},t("animation-meter").onmouseup=function(a){if(0===a.button){var c,d=t("animation-marker");"animation-meter"==a.target.id?(c=void 0===a.offsetX?a.layerX-t("animation-meter").offsetLeft-8:a.offsetX-3,c>372&&(c=372),-3>c&&(c=-3),d.style.left=c+"px",y=a.clientX):c=void 0===d.style.left?0:Number(d.style.left.split("p")[0]);var e=(c+3)/375,f=b.lastframe*e;d=null,x=!1,b.setTime(f)}},b.onstep=this.step,b.onstatus=this.state};z.prototype.step=function(a,b){a/=1e3;var c=a/b,d=Math.floor(a/60)+":",e=String(Math.floor(a%60));d+=1==e.length?"0":"",t("animation-time").innerHTML=d+e,x||(t("animation-marker").style.left=375*c-3+"px")},z.prototype.state=function(a){t("animation-toggle").className="animation-control "+a},a.AnimationScene=s,a.CartoonAnimation=n}(window);